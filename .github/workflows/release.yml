name: ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    tags:
      - 'v*'

env:
  PYTHON_VERSION: '3.11'  # å®‰å®šæ€§ã®ãŸã‚3.11ã‚’ä½¿ç”¨ã€3.13ã¯å°†æ¥å¯¾å¿œäºˆå®š

jobs:
  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  documentation-check:
    name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      shell: bash
      run: |
        echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é–‹å§‹"
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        tag="${{ github.ref_name }}"
        version="${tag#v}"
        echo "ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $version"
        
        # pyproject.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        pyproject_version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        if [ "$pyproject_version" != "$version" ]; then
          echo "ã‚¨ãƒ©ãƒ¼: pyproject.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³($pyproject_version)ãŒã‚¿ã‚°($version)ã¨ä¸€è‡´ã—ã¾ã›ã‚“"
          exit 1
        fi
        echo "pyproject.tomlãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª: $pyproject_version"
        
        # version.txtã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if [ -f version.txt ]; then
          version_txt=$(cat version.txt | tr -d '\n\r')
          if [ "$version_txt" != "$version" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: version.txtã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³($version_txt)ãŒã‚¿ã‚°($version)ã¨ä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi
        fi
        
        # å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        required_docs=(
          "README.md"
          "docs/FEATURES.md" 
          "docs/RELEASE_NOTES.md"
          "docs/USER_MANUAL.md"
          "docs/TROUBLESHOOTING_GUIDE.md"
          "LICENSE"
        )
        
        for doc in "${required_docs[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ $doc ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
        done
        
        # RELEASE_NOTES.mdã«ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if ! grep -q "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $version\|Version $version\|v$version" docs/RELEASE_NOTES.md; then
          echo "ã‚¨ãƒ©ãƒ¼: docs/RELEASE_NOTES.mdã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $version ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        # README.mdã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‚ç…§ãƒã‚§ãƒƒã‚¯
        if ! grep -q "$version" README.md; then
          echo "è­¦å‘Š: README.mdã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $version ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“"
        fi
        
        echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
  quality-gate:
    name: å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [documentation-check]
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Qtä¾å­˜é–¢ä¿‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libegl1 libxkbcommon-x11-0 libxcb-xinerama0
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 3
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,security,performance]
    
    - name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        
        # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        python -m py_compile main.py
        find src -name "*.py" -exec python -m py_compile {} \;
        
        # å‹ãƒã‚§ãƒƒã‚¯
        mypy src/ --ignore-missing-imports
        
        # ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
        black --check --diff src/ tests/
        isort --check-only --diff src/ tests/
        flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503,E501
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        mkdir -p reports
        bandit -r src/ -f json -o reports/bandit-report.json || true
        safety check --json --output reports/safety-report.json || true
        
        echo "ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†"
    
    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹"
        
        # å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCI.ymlã¨åŒã˜è¨­å®šï¼‰
        pytest tests/ -v --tb=short \
          --cov=src \
          --cov-report=xml:reports/coverage.xml \
          --cov-report=term-missing \
          --junit-xml=reports/test-results.xml \
          --maxfail=3 --timeout=120
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆãƒªãƒªãƒ¼ã‚¹ç”¨ã¯é–¾å€¤ãƒã‚§ãƒƒã‚¯ãªã—ï¼‰
        coverage report
        
        echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
      env:
        DISPLAY: :99
        QT_QPA_PLATFORM: offscreen
        QT_LOGGING_RULES: "*.debug=false"
    
    - name: å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
      run: |
        echo "å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ1000è¡Œä»¥ä¸‹ï¼‰
        find src -name "*.py" -exec wc -l {} + | grep -v "total" | awk '$1 > 1000 {print "è­¦å‘Š: " $2 " ãŒ1000è¡Œã‚’è¶…ãˆã¦ã„ã¾ã™ (" $1 "è¡Œ)"; exit_code=1} END {exit exit_code}'
        
        # å¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯
        python -c "
        import ast
        import os
        from collections import defaultdict
        
        def check_circular_imports():
            imports = defaultdict(set)
            for root, dirs, files in os.walk('src'):
                for file in files:
                    if file.endswith('.py'):
                        filepath = os.path.join(root, file)
                        with open(filepath, 'r', encoding='utf-8') as f:
                            try:
                                tree = ast.parse(f.read())
                                module = filepath.replace('src/', '').replace('/', '.').replace('.py', '')
                                for node in ast.walk(tree):
                                    if isinstance(node, ast.Import):
                                        for alias in node.names:
                                            if alias.name.startswith('src.'):
                                                imports[module].add(alias.name.replace('src.', ''))
                                    elif isinstance(node, ast.ImportFrom):
                                        if node.module and node.module.startswith('src.'):
                                            imports[module].add(node.module.replace('src.', ''))
                            except:
                                pass
            
            # ç°¡å˜ãªå¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯
            for module, deps in imports.items():
                for dep in deps:
                    if module in imports.get(dep, set()):
                        print(f'è­¦å‘Š: å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º: {module} <-> {dep}')
        
        check_circular_imports()
        "
        
        echo "å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèªå®Œäº†"
    
    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: reports/

  # ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ
  build-and-test:
    name: ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ
    runs-on: windows-latest
    timeout-minutes: 60
    needs: [quality-gate]
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e .[build]
    
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
      run: |
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰é–‹å§‹"
        cd build_scripts
        python build_windows.py
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰å®Œäº†"
    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      run: |
        echo "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª"
        
        # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if (Test-Path "installer/DocMind_Setup_v${{ github.ref_name }}.exe") {
          $fileSize = (Get-Item "installer/DocMind_Setup_v${{ github.ref_name }}.exe").Length
          echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚µã‚¤ã‚º: $($fileSize / 1MB) MB"
          
          if ($fileSize -lt 50MB) {
            echo "è­¦å‘Š: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚µã‚¤ã‚ºãŒå°ã•ã™ãã¾ã™"
            exit 1
          }
        } else {
          echo "ã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        }
    

    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: installer/DocMind_Setup_v${{ github.ref_name }}.exe

  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-and-test]
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: windows-installer
        path: ./artifacts/
    
    - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æº–å‚™
      run: |
        echo "ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æº–å‚™"
        
        # docs/RELEASE_NOTES.mdã‹ã‚‰è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å†…å®¹ã‚’æŠ½å‡º
        version="${{ github.ref_name }}"
        version_clean="${version#v}"
        
        # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        awk "/## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $version_clean/,/## ãƒãƒ¼ã‚¸ãƒ§ãƒ³|$/" docs/RELEASE_NOTES.md > release_notes_current.md
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæƒ…å ±ã®è¿½åŠ 
        installer_size=$(stat -c%s "artifacts/DocMind_Setup_v$version.exe" | awk '{print int($1/1024/1024) " MB"}')
        echo "" >> release_notes_current.md
        echo "### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æƒ…å ±" >> release_notes_current.md
        echo "- **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚µã‚¤ã‚º**: $installer_size" >> release_notes_current.md
        echo "- **å¯¾å¿œOS**: Windows 10/11 (64-bit)" >> release_notes_current.md
        echo "- **å¿…è¦ãƒ¡ãƒ¢ãƒª**: 4GBä»¥ä¸Šï¼ˆ8GBæ¨å¥¨ï¼‰" >> release_notes_current.md
    
    - name: GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
      uses: softprops/action-gh-release@v1
      with:
        name: DocMind ${{ github.ref_name }}
        body_path: release_notes_current.md
        files: |
          artifacts/DocMind_Setup_v${{ github.ref_name }}.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ‰ DocMind ${{ github.ref_name }} ã®ãƒªãƒªãƒ¼ã‚¹ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

  # ãƒªãƒªãƒ¼ã‚¹å¾Œã®æ¤œè¨¼
  post-release-validation:
    name: ãƒªãƒªãƒ¼ã‚¹å¾Œæ¤œè¨¼
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [create-release]
    if: always()
    
    steps:
    - name: ãƒªãƒªãƒ¼ã‚¹çŠ¶æ³ã®ç¢ºèª
      run: |
        echo "ãƒªãƒªãƒ¼ã‚¹çŠ¶æ³ã®ç¢ºèª"
        
        # GitHub APIã§ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
        release_info=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}")
        
        # ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
        if echo "$release_info" | grep -q '"draft": false'; then
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«å…¬é–‹ã•ã‚Œã¾ã—ãŸ"
        else
          echo "âŒ ãƒªãƒªãƒ¼ã‚¹ã®å…¬é–‹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
          exit 1
        fi
        
        # ã‚¢ã‚»ãƒƒãƒˆãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‹ç¢ºèª
        if echo "$release_info" | grep -q "DocMind_Setup_v${{ github.ref_name }}.exe"; then
          echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ"
        else
          echo "âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
          exit 1
        fi
    
    - name: æ¬¡æœŸé–‹ç™ºæº–å‚™ã®ææ¡ˆ
      run: |
        echo "ğŸš€ æ¬¡æœŸé–‹ç™ºæº–å‚™ã®ææ¡ˆ"
        echo "1. é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„"
        echo "2. æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„"
        echo "3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®åé›†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„"
        echo "4. æ—¢çŸ¥ã®å•é¡Œã®ä¿®æ­£ã‚’è¨ˆç”»ã—ã¦ãã ã•ã„"