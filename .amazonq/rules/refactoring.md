# リファクタリングルール

## 基本方針

### 1. 段階的リファクタリング
- **一度に全てを変更しない**: 機能単位で段階的に分離
- **既存機能保持**: リファクタリング中も全機能が動作することを保証
- **テスト駆動**: 各段階でテストスイートが通ることを確認
- **ロールバック可能**: 問題発生時は即座に前の状態に戻せる

### 2. 責務分離の原則
- **単一責任原則**: 1つのクラスは1つの責務のみ
- **依存関係の最小化**: コンポーネント間の結合度を下げる
- **インターフェース分離**: 必要な機能のみを公開
- **依存性注入**: 具象クラスではなくインターフェースに依存

### 3. コード品質基準
- **メソッド数制限**: 1クラス最大20メソッド
- **行数制限**: 1ファイル最大500行
- **循環参照禁止**: import文の循環参照を避ける
- **命名規則**: 責務が明確になる名前を使用

## Phase1完了: main_window.py リファクタリング成果

### ✅ 完了済み分離コンポーネント
1. **UI構築系** → `managers/layout_manager.py` (15メソッド)
2. **進捗管理系** → `managers/progress_manager.py` (16メソッド)
3. **シグナル管理系** → `managers/signal_manager.py` (9メソッド)
4. **インデックス制御系** → `controllers/index_controller.py` (25メソッド)
5. **ダイアログ系** → `dialogs/dialog_manager.py` (15メソッド)
6. **クリーンアップ系** → `managers/cleanup_manager.py` (7メソッド)

### 📊 Phase1成果指標
- **行数削減**: 3,605行 → 1,974行 (45.2%削減)
- **メソッド削減**: 112個 → 73個 (34.8%削減)
- **品質保証**: 全コンポーネント正常動作確認済み
- **アーキテクチャ**: 責務分離・保守性・拡張性確保

## Phase2計画: search_interface.py リファクタリング

### 🎯 Phase2最優先ターゲット
- **対象ファイル**: `src/gui/search_interface.py`
- **現在規模**: 1,504行, 79メソッド
- **目標規模**: 150行以下 (90%削減)
- **期間**: 2025年1月-2月

### 分離対象の分類（Phase2）
1. **検索UI管理系** → `managers/search_ui_manager.py`
2. **検索実行系** → `controllers/search_controller.py`
3. **結果表示系** → `managers/result_display_manager.py`
4. **フィルタ管理系** → `managers/filter_manager.py`
5. **プレビュー系** → `managers/preview_manager.py`
6. **検索履歴系** → `managers/search_history_manager.py`

### Phase2での検証項目
- [ ] 検索機能が正常に動作する
- [ ] 結果表示・フィルタリングが正常動作する
- [ ] プレビュー機能が正常動作する
- [ ] 検索履歴機能が正常動作する
- [ ] パフォーマンスが劣化していない

## 実装ガイドライン

### 基底クラスの設計
```python
from abc import ABC, abstractmethod
from typing import Protocol

class ManagerProtocol(Protocol):
    """マネージャークラスの共通インターフェース"""
    def initialize(self) -> None: ...
    def cleanup(self) -> None: ...
```

### 依存性注入パターン
```python
class MainWindow(QMainWindow):
    def __init__(self):
        # 各マネージャーを注入
        self.layout_manager = LayoutManager(self)
        self.progress_manager = ProgressManager(self)
        # ...
```

### エラーハンドリング
- 各コンポーネントで適切な例外処理
- ログ出力による問題の追跡可能性
- ユーザーへの分かりやすいエラーメッセージ

## 禁止事項

### やってはいけないこと
- **一括置換**: 大量のコードを一度に移動しない
- **テスト無視**: テストを実行せずに次の段階に進まない
- **機能削除**: リファクタリングで既存機能を削除しない
- **命名変更**: 外部インターフェースの名前を勝手に変更しない

### 危険な操作
- **import文の大幅変更**: 一度に多くのimport文を変更しない
- **シグナル接続の変更**: Qt シグナル・スロットの接続を不用意に変更しない
- **スレッド処理の変更**: マルチスレッド処理の変更は特に慎重に

## 品質チェック

### コードレビューポイント
- [ ] 責務が明確に分離されているか
- [ ] 循環参照が発生していないか
- [ ] 適切な型ヒントが付与されているか
- [ ] ドキュメント文字列が記述されているか
- [ ] エラーハンドリングが適切か

### パフォーマンスチェック
- [ ] 起動時間が劣化していないか
- [ ] メモリ使用量が増加していないか
- [ ] UI応答性が維持されているか
- [ ] 検索性能が劣化していないか

## 緊急時対応

### Phase2用ロールバック手順
```bash
# Phase2問題発生時の緊急ロールバック
git checkout main
git branch -D refactor/search-interface-phase2

# 新しいブランチで再開
git checkout -b refactor/search-interface-phase2-v2
```

### Phase1成果の保護
```bash
# Phase1成果は保護済み（mainブランチにマージ済み）
# Phase2作業はPhase1成果を基盤として実施
git checkout -b refactor/search-interface-phase2
```

### 部分的ロールバック
- 特定のコミットのみを取り消す場合は `git revert` を使用
- 機能単位でのロールバックを可能にするため、コミットは細かく分ける

## 成功指標

### Phase1達成済み指標
- ✅ main_window.py: 3,605行 → 1,974行（45.2%削減）
- ✅ メソッド数: 112個 → 73個（34.8%削減）
- ✅ 全機能正常動作確認
- ✅ 品質保証完了（メモリ効率・起動時間・依存関係）

### Phase2目標指標
- search_interface.py: 1,504行 → 150行以下（90%削減）
- メソッド数: 79個 → 10個以下（87%削減）
- 検索性能維持・向上
- UI応答性向上

### 全体目標（2025-2026年）
- 巨大ファイル完全解消（500行以下）
- テスト実行時間: 30%短縮
- 新機能追加時間: 50%短縮
- コードの可読性・保守性・テスト容易性向上