# リファクタリングルール

## 基本方針

### 1. 段階的リファクタリング
- **一度に全てを変更しない**: 機能単位で段階的に分離
- **既存機能保持**: リファクタリング中も全機能が動作することを保証
- **テスト駆動**: 各段階でテストスイートが通ることを確認
- **ロールバック可能**: 問題発生時は即座に前の状態に戻せる

### 2. 責務分離の原則
- **単一責任原則**: 1つのクラスは1つの責務のみ
- **依存関係の最小化**: コンポーネント間の結合度を下げる
- **インターフェース分離**: 必要な機能のみを公開
- **依存性注入**: 具象クラスではなくインターフェースに依存

### 3. コード品質基準
- **メソッド数制限**: 1クラス最大20メソッド
- **行数制限**: 1ファイル最大500行
- **循環参照禁止**: import文の循環参照を避ける
- **命名規則**: 責務が明確になる名前を使用

## main_window.py リファクタリング固有ルール

### 分離対象の分類
1. **UI構築系** → `managers/layout_manager.py`
2. **進捗管理系** → `managers/progress_manager.py`
3. **シグナル管理系** → `managers/signal_manager.py`
4. **インデックス制御系** → `controllers/index_controller.py`
5. **ダイアログ系** → `dialogs/dialog_manager.py`
6. **クリーンアップ系** → `managers/cleanup_manager.py`

### 移動時の注意事項
- **シグナル・スロット接続の維持**: Qt のシグナル接続を破綻させない
- **import文の管理**: 循環参照を避け、必要最小限のimportのみ
- **メソッド名の保持**: 外部から呼び出されるメソッド名は変更しない
- **型ヒントの追加**: 移動時に型ヒントを必ず追加

### 各段階での検証項目
- [ ] アプリケーションが正常に起動する
- [ ] 全ての既存機能が動作する
- [ ] テストスイートが全て通る
- [ ] メモリリークが発生していない
- [ ] パフォーマンスが劣化していない

## 実装ガイドライン

### 基底クラスの設計
```python
from abc import ABC, abstractmethod
from typing import Protocol

class ManagerProtocol(Protocol):
    """マネージャークラスの共通インターフェース"""
    def initialize(self) -> None: ...
    def cleanup(self) -> None: ...
```

### 依存性注入パターン
```python
class MainWindow(QMainWindow):
    def __init__(self):
        # 各マネージャーを注入
        self.layout_manager = LayoutManager(self)
        self.progress_manager = ProgressManager(self)
        # ...
```

### エラーハンドリング
- 各コンポーネントで適切な例外処理
- ログ出力による問題の追跡可能性
- ユーザーへの分かりやすいエラーメッセージ

## 禁止事項

### やってはいけないこと
- **一括置換**: 大量のコードを一度に移動しない
- **テスト無視**: テストを実行せずに次の段階に進まない
- **機能削除**: リファクタリングで既存機能を削除しない
- **命名変更**: 外部インターフェースの名前を勝手に変更しない

### 危険な操作
- **import文の大幅変更**: 一度に多くのimport文を変更しない
- **シグナル接続の変更**: Qt シグナル・スロットの接続を不用意に変更しない
- **スレッド処理の変更**: マルチスレッド処理の変更は特に慎重に

## 品質チェック

### コードレビューポイント
- [ ] 責務が明確に分離されているか
- [ ] 循環参照が発生していないか
- [ ] 適切な型ヒントが付与されているか
- [ ] ドキュメント文字列が記述されているか
- [ ] エラーハンドリングが適切か

### パフォーマンスチェック
- [ ] 起動時間が劣化していないか
- [ ] メモリ使用量が増加していないか
- [ ] UI応答性が維持されているか
- [ ] 検索性能が劣化していないか

## 緊急時対応

### ロールバック手順
```bash
# 問題発生時の緊急ロールバック
git checkout main
git branch -D refactor/main-window-phase1

# 新しいブランチで再開
git checkout -b refactor/main-window-phase1-v2
```

### 部分的ロールバック
- 特定のコミットのみを取り消す場合は `git revert` を使用
- 機能単位でのロールバックを可能にするため、コミットは細かく分ける

## 成功指標

### 定量的指標
- main_window.py: 3,605行 → 300行以下（92%削減）
- メソッド数: 112個 → 10個以下（91%削減）
- テスト実行時間: 30%短縮
- 新機能追加時間: 50%短縮

### 定性的指標
- コードの可読性向上
- 保守性の向上
- テスト容易性の向上
- 開発効率の向上