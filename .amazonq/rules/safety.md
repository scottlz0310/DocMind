# 安全性ルール

## リファクタリング時の安全性確保

### 1. 変更前の必須チェック
- **動作確認**: 現在のコードが正常に動作することを確認
- **テスト実行**: 全てのテストが通ることを確認
- **バックアップ**: 変更前の状態をGitで保存
- **依存関係確認**: 変更対象の依存関係を把握

### 2. 段階的変更の原則
- **小さな変更**: 一度に変更するのは1つの責務のみ
- **即座の検証**: 各変更後に動作確認を実施
- **コミット分割**: 機能単位で細かくコミット
- **ロールバック準備**: いつでも前の状態に戻せる準備

### 3. 破綻防止策
- **import循環参照**: 新しいimport文追加時は循環参照をチェック
- **シグナル接続**: Qt シグナル・スロットの接続を維持
- **スレッド安全性**: マルチスレッド処理の整合性を保持
- **リソース管理**: メモリリーク・ファイルハンドルリークを防止

## 危険な操作の回避

### 絶対にやってはいけないこと
- **テスト無視**: テストを実行せずに次の変更に進む
- **一括変更**: 大量のコードを一度に移動・変更
- **機能削除**: 既存機能を削除してしまう
- **外部API変更**: 他のコンポーネントから呼び出されるメソッドの削除・名前変更

### 注意が必要な操作
- **import文の変更**: 依存関係の変更は慎重に
- **クラス継承の変更**: 継承関係の変更は影響範囲が大きい
- **例外処理の変更**: エラーハンドリングの変更は予期しない動作を引き起こす可能性
- **設定ファイルの変更**: 設定の変更は全体に影響する

## 検証手順

### 各段階での必須チェック
1. **仮想環境アクティベート**: Python実行前に必ず仮想環境をアクティベート
2. **コンパイルチェック**: Pythonの構文エラーがないか
3. **import チェック**: 全てのimportが正常に解決されるか
4. **起動チェック**: アプリケーションが正常に起動するか
5. **機能チェック**: 主要機能が正常に動作するか
6. **テストチェック**: 自動テストが全て通るか

### 詳細検証項目
- [ ] メインウィンドウが表示される
- [ ] フォルダ選択機能が動作する
- [ ] 検索機能が動作する
- [ ] インデックス作成機能が動作する
- [ ] プレビュー機能が動作する
- [ ] 設定画面が表示される
- [ ] エラーダイアログが適切に表示される

## エラー対応

### 問題発生時の対応手順
1. **即座停止**: 問題を発見したら作業を停止
2. **状況記録**: エラーメッセージ・再現手順を記録
3. **原因特定**: 変更箇所と問題の関連性を調査
4. **修正 or ロールバック**: 修正可能なら修正、困難ならロールバック
5. **再検証**: 修正後は必ず全体の動作確認

### よくある問題と対策
- **ImportError**: import文の循環参照 → 依存関係を見直し
- **AttributeError**: メソッド名の変更漏れ → 呼び出し箇所を全て確認
- **RuntimeError**: Qt オブジェクトの不正操作 → オブジェクトライフサイクルを確認
- **MemoryError**: メモリリーク → リソース管理を確認

## 品質保証

### コード品質チェック
- **型ヒント**: 全ての関数・メソッドに型ヒントを追加
- **ドキュメント**: クラス・メソッドにdocstringを記述
- **命名規則**: PEP8に準拠した命名
- **コメント**: 複雑な処理には適切なコメント

### パフォーマンスチェック
- **起動時間**: アプリケーション起動時間の測定
- **メモリ使用量**: メモリ使用量の監視
- **応答性**: UI操作の応答性確認
- **処理速度**: 検索・インデックス作成速度の確認

## 緊急時プロトコル

### 重大な問題発生時
1. **作業停止**: 全ての変更作業を停止
2. **状況報告**: 問題の詳細を記録
3. **緊急ロールバック**: mainブランチに戻す
4. **原因分析**: 問題の根本原因を分析
5. **対策立案**: 再発防止策を検討

### Python実行時の必須手順
```bash
# Python実行前に必ず仮想環境をアクティベート
source venv/bin/activate  # Linux/macOS
# または
venv\Scripts\activate  # Windows

# 構文チェック例
python -m py_compile src/gui/main_window.py

# アプリケーション起動例
python main.py
```

### ロールバック手順
```bash
# 緊急時の完全ロールバック
git stash  # 未コミットの変更を退避
git checkout main  # mainブランチに戻る
git branch -D refactor/main-window-phase1  # 問題のあるブランチを削除

# 状況確認（仮想環境アクティベート後）
source venv/bin/activate  # 仮想環境をアクティベート
python main.py  # アプリケーションが正常動作することを確認
```