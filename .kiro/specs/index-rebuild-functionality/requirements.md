# インデックス再構築機能 要件定義書

## はじめに

DocMindアプリケーションにおいて、ユーザーが検索インデックスを手動で再構築できる機能を実装します。現在のメインウィンドウには再構築メニューが存在しますが、実際の処理が実装されていないため、既存の`IndexingWorker`と`IndexingThreadManager`を活用して完全な機能として実装する必要があります。

## 要件

### 要件1: インデックス再構築の実行

**ユーザーストーリー:** ユーザーとして、検索結果が不正確になった場合や新しいドキュメントが追加された場合に、検索インデックスを手動で再構築したい。

#### 受入基準

1. WHEN ユーザーがメニューから「インデックス再構築」を選択 THEN システムは確認ダイアログを表示する SHALL
2. WHEN ユーザーが確認ダイアログで「はい」を選択 THEN システムは既存のIndexingThreadManagerを使用してインデックス再構築を開始する SHALL
3. WHEN インデックス再構築が開始される THEN システムは既存のIndexingWorkerを活用してバックグラウンドで処理を実行する SHALL
4. WHEN インデックス再構築中 THEN システムは既存の進捗表示機能を使用してUIをブロックせずに処理状況を表示する SHALL

### 要件2: 進捗表示とユーザーフィードバック

**ユーザーストーリー:** ユーザーとして、インデックス再構築の進捗状況を視覚的に確認し、処理が完了したことを知りたい。

#### 受入基準

1. WHEN インデックス再構築が開始される THEN システムは既存のshow_progressメソッドを使用して「インデックスを再構築中...」メッセージと進捗バーを表示する SHALL
2. WHEN ドキュメントの処理が進行中 THEN システムはIndexingWorkerの進捗シグナルを受信して「処理済み/総数」形式で進捗を更新する SHALL
3. WHEN インデックス再構築が完了 THEN システムはIndexingThreadManagerの完了シグナルを受信して「インデックス再構築が完了しました」メッセージを表示する SHALL
4. WHEN インデックス再構築中にエラーが発生 THEN システムはIndexingThreadManagerのエラーシグナルを受信してエラーメッセージを表示する SHALL

### 要件3: エラーハンドリングと回復処理

**ユーザーストーリー:** ユーザーとして、インデックス再構築中にエラーが発生した場合でも、アプリケーションが安定して動作し続けることを期待する。

#### 受入基準

1. WHEN インデックス再構築中にファイルアクセスエラーが発生 THEN IndexingWorkerの既存エラーハンドリング機能により該当ファイルをスキップして処理を継続する SHALL
2. WHEN インデックス再構築中に重大なエラーが発生 THEN IndexingThreadManagerのエラーシグナルを通じて処理を中断し、ユーザーに分かりやすいエラーメッセージを表示する SHALL
3. WHEN エラーが発生してインデックス再構築が中断 THEN システムはIndexManagerのclear_indexメソッドを使用して部分的に構築されたインデックスをクリアする SHALL
4. WHEN インデックス再構築が失敗 THEN システムは既存のインデックスをクリアして一貫性を保ち、ユーザーに再試行を促す SHALL

### 要件4: パフォーマンスと応答性

**ユーザーストーリー:** ユーザーとして、インデックス再構築中でもアプリケーションの他の機能(プレビュー表示など)を使用したい。

#### 受入基準

1. WHEN インデックス再構築が実行中 THEN IndexingThreadManagerによりメインUIスレッドをブロックしない SHALL
2. WHEN インデックス再構築中 THEN ユーザーはプレビューペインやフォルダツリーを操作できる SHALL
3. WHEN インデックス再構築中 THEN 新しい検索リクエストは適切にハンドリングされる(無効化または待機)SHALL
4. WHEN 大量のドキュメント(1000ファイル以上)を処理 THEN IndexingWorkerの既存メモリ管理機能によりメモリリークを防ぐ SHALL

### 要件5: システム状態の更新

**ユーザーストーリー:** ユーザーとして、インデックス再構築後にシステム情報が正しく更新されることを期待する。

#### 受入基準

1. WHEN インデックス再構築が完了 THEN システム情報ラベルにインデックス状態を更新表示する SHALL
2. WHEN インデックス再構築が完了 THEN 検索機能が新しいインデックスを使用するように更新される SHALL
3. WHEN インデックス再構築が完了 THEN SearchManagerのclear_suggestion_cacheメソッドを使用して検索提案キャッシュをクリアする SHALL
4. WHEN インデックス再構築が完了 THEN フォルダツリーのインデックス状態表示が更新される SHALL

### 要件6: タイムアウト処理と復旧機能

**ユーザーストーリー:** ユーザーとして、インデックス再構築処理がハングアップした場合でも、適切にタイムアウトして復旧できることを期待する。

#### 受入基準

1. WHEN インデックス再構築が一定時間(30分)以上応答しない THEN システムはタイムアウトを検出してプロセスを中断する SHALL
2. WHEN タイムアウトが発生 THEN システムはユーザーに分かりやすいタイムアウトメッセージを表示する SHALL
3. WHEN タイムアウト後 THEN システムは部分的に構築されたインデックスをクリアして一貫性を保つ SHALL
4. WHEN タイムアウト後 THEN ユーザーは再度インデックス再構築を実行できる SHALL
5. WHEN 処理が長時間実行中 THEN システムは定期的に進捗を更新して応答性を示す SHALL

### 要件7: 既存コンポーネントとの統合

**ユーザーストーリー:** 開発者として、既存のIndexingWorkerとIndexingThreadManagerを最大限活用して、重複実装を避けたい。

#### 受入基準

1. WHEN インデックス再構築機能を実装 THEN 既存のIndexingWorkerクラスを再利用する SHALL
2. WHEN インデックス再構築機能を実装 THEN 既存のIndexingThreadManagerクラスを再利用する SHALL
3. WHEN インデックス再構築機能を実装 THEN 既存のシグナル接続パターンを踏襲する SHALL
4. WHEN インデックス再構築機能を実装 THEN 新しいコードは既存のアーキテクチャパターンに従う SHALL