# 実際のインデックス処理実装 - 要件定義書

## はじめに

現在のDocMindアプリケーションは、フォルダインデックス機能において「見た目だけ」の実装となっており、実際のファイル処理、ドキュメント解析、インデックス作成が行われていません。この機能は、ユーザーがフォルダを選択して「インデックスに追加」をクリックした際に、実際にファイルをスキャンし、ドキュメントを処理し、検索可能なインデックスを作成する必要があります。

## 要件

### 要件1: 実際のファイルスキャンとドキュメント処理

**ユーザーストーリー:** ユーザーとして、フォルダを「インデックスに追加」した時に、実際にそのフォルダ内のすべてのファイルがスキャンされ、処理されることを期待する。これにより、後で検索した際に実際にファイル内容が検索結果に表示される。

#### 受入基準

1. ユーザーがフォルダツリーでフォルダを選択し「インデックスに追加」をクリックした時、システムは選択されたフォルダ内のすべてのファイルを再帰的にスキャンする
2. ファイルスキャン中、システムはサポートされているファイル形式（PDF、Word、Excel、Markdown、テキスト）を識別し、処理対象として分類する
3. 各ファイルを処理する時、システムはDocumentProcessorを使用してファイル内容を抽出し、Document オブジェクトを作成する
4. ドキュメント処理が完了した時、システムは処理されたドキュメント数と失敗したファイル数を記録する
5. ファイル処理中にエラーが発生した時、システムはエラーをログに記録し、他のファイルの処理を継続する

### 要件2: インデックスマネージャーとの統合

**ユーザーストーリー:** ユーザーとして、処理されたドキュメントが実際に検索可能なインデックスに追加されることを期待する。これにより、後で検索クエリを実行した際に、インデックス化されたファイルが検索結果に表示される。

#### 受入基準

1. ドキュメントが処理された時、システムはIndexManagerを使用してドキュメントをWhoosh検索インデックスに追加する
2. インデックス追加処理中、システムはドキュメントのメタデータ（ファイルパス、作成日時、サイズ、ファイル形式）をデータベースに保存する
3. インデックス作成が完了した時、システムは新しく追加されたドキュメント数をログに記録する
4. インデックス処理中にエラーが発生した時、システムは部分的に処理されたインデックスを適切にクリーンアップする
5. インデックス作成後、システムは検索機能でインデックス化されたドキュメントが検索可能であることを確認する

### 要件3: バックグラウンド処理とプログレス表示

**ユーザーストーリー:** ユーザーとして、インデックス処理が実行されている間、実際の処理進捗を確認したい。また、処理中もアプリケーションが応答性を保つことを期待する。

#### 受入基準

1. インデックス処理を開始する時、システムはメインUIスレッドをブロックしないようにバックグラウンドスレッドで処理を実行する
2. 処理中、システムは現在処理中のファイル名と全体の進捗率（処理済みファイル数/総ファイル数）を表示する
3. 進捗表示中、システムは「ファイルをスキャン中...」「ドキュメントを処理中...」「インデックスを作成中...」など、現在の処理段階を明確に表示する
4. 処理が完了した時、システムは「インデックス作成完了: X個のファイルを処理しました」のような具体的な結果を表示する
5. 処理中にユーザーがキャンセルした時、システムは処理を安全に停止し、部分的に作成されたインデックスを適切に処理する

### 要件4: ファイル監視の開始

**ユーザーストーリー:** ユーザーとして、フォルダをインデックス化した後、そのフォルダ内でファイルが追加・変更・削除された時に、自動的にインデックスが更新されることを期待する。

#### 受入基準

1. フォルダのインデックス作成が完了した時、システムはそのフォルダに対してFileWatcherを開始する
2. ファイル監視が開始された時、システムは監視対象フォルダをログに記録し、監視状態を内部で管理する
3. 監視中にファイルが追加された時、システムは新しいファイルを自動的に処理してインデックスに追加する
4. 監視中にファイルが変更された時、システムは変更されたファイルを再処理してインデックスを更新する
5. 監視中にファイルが削除された時、システムはインデックスから該当するドキュメントを削除する

### 要件5: エラーハンドリングと回復機能

**ユーザーストーリー:** ユーザーとして、インデックス処理中にエラーが発生した場合でも、適切なエラーメッセージが表示され、可能な限り処理が継続されることを期待する。

#### 受入基準

1. ファイル読み取りエラーが発生した時、システムはエラーをログに記録し、該当ファイルをスキップして次のファイルの処理を継続する
2. ドキュメント処理エラーが発生した時、システムはエラーの詳細をログに記録し、ユーザーに分かりやすいエラーメッセージを表示する
3. インデックス作成エラーが発生した時、システムは部分的に作成されたインデックスの状態を確認し、必要に応じて修復を試行する
4. 重大なエラーが発生した時、システムはユーザーに問題の詳細と推奨される対処法を表示する
5. エラー発生後、システムは次回のインデックス処理で問題のあったファイルを再試行する機能を提供する

### 要件6: パフォーマンス最適化

**ユーザーストーリー:** ユーザーとして、大量のファイルを含むフォルダをインデックス化する際も、合理的な時間内で処理が完了することを期待する。

#### 受入基準

1. 大量のファイル（1000個以上）を処理する時、システムはバッチ処理を使用してメモリ使用量を制御する
2. 処理中、システムはCPU使用率を監視し、システムの応答性を維持するために必要に応じて処理速度を調整する
3. 同じファイルを再処理する時、システムはファイルの変更日時をチェックして、変更されていないファイルの処理をスキップする
4. インデックス作成中、システムは定期的にメモリ使用量をチェックし、必要に応じてガベージコレクションを実行する
5. 処理完了後、システムは処理時間、処理されたファイル数、エラー数などの統計情報をログに記録する
