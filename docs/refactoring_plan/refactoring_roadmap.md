# DocMind リファクタリング実行ロードマップ

## 🎯 プロジェクト概要

**目標**: main_window.py(3,605行、112メソッド)を6つの責務別コンポーネントに分離
**期間**: 4-5週間
**優先度**: 最高(開発効率とコード品質に直結)

## 📊 現状分析サマリー

### 問題の深刻度
```
main_window.py: 3,605行(全GUI層の42%)
- 1クラスに112メソッド(通常の10倍)
- 6つの異なる責務が混在
- テスト困難、機能追加時の影響範囲が不明
```

### 他の問題ファイル
```
search_interface.py: 1,504行(7クラス、79メソッド)
folder_tree.py: 1,409行(5クラス、75メソッド)
→ main_window.py解決後に対処
```

## 🗓️ 実行スケジュール

### Week 1: 基盤整備・準備
**目標**: 安全なリファクタリング環境の構築

#### Day 1-2: 環境準備
- [ ] 新しいディレクトリ構造作成
- [ ] 基底クラス・インターフェース設計
- [ ] 既存テストスイートの実行確認

#### Day 3-5: 第1段階分離(ダイアログ系)
- [ ] `dialogs/dialog_manager.py` 作成
- [ ] 25個のダイアログ関連メソッド移動
- [ ] 動作確認・テスト実行

### Week 2: コア機能分離
**目標**: 最も複雑な部分の分離

#### Day 1-3: 進捗管理系分離
- [ ] `managers/progress_manager.py` 作成
- [ ] 12個の進捗関連メソッド移動
- [ ] UI更新ロジックの動作確認

#### Day 4-5: インデックス制御系分離
- [ ] `controllers/index_controller.py` 作成
- [ ] 25個のインデックス関連メソッド移動
- [ ] スレッド管理・エラーハンドリング確認

### Week 3: UI・イベント管理分離
**目標**: UI構築とイベント処理の分離

#### Day 1-3: UI構築系分離
- [ ] `managers/layout_manager.py` 作成
- [ ] 15個のUI構築メソッド移動
- [ ] レイアウト・スタイリング確認

#### Day 4-5: シグナル管理系分離
- [ ] `managers/signal_manager.py` 作成
- [ ] 20個のシグナル関連メソッド移動
- [ ] イベント処理フロー確認

### Week 4: 最終統合・クリーンアップ
**目標**: 完全な分離と品質確保

#### Day 1-2: クリーンアップ系分離
- [ ] `managers/cleanup_manager.py` 作成
- [ ] 15個のクリーンアップメソッド移動
- [ ] 終了処理・リソース管理確認

#### Day 3-5: 統合・最適化
- [ ] main_window.py の最終形態実装
- [ ] 全機能統合テスト
- [ ] パフォーマンス測定・最適化

### Week 5: 品質保証・ドキュメント
**目標**: 本番投入準備

#### Day 1-3: 品質保証
- [ ] 全機能テスト(手動・自動)
- [ ] メモリリーク・パフォーマンステスト
- [ ] エラーケーステスト

#### Day 4-5: ドキュメント・次段階準備
- [ ] リファクタリング結果ドキュメント作成
- [ ] 次段階(search_interface.py)計画策定
- [ ] チーム共有・レビュー

## 📁 新しいディレクトリ構造

```
src/gui/
├── main_window.py              # 統合管理のみ(300行以下)
├── managers/                   # UI・状態管理
│   ├── __init__.py
│   ├── layout_manager.py       # UI構築・レイアウト(15メソッド)
│   ├── progress_manager.py     # 進捗・ステータス管理(12メソッド)
│   ├── signal_manager.py       # シグナル・イベント管理(20メソッド)
│   └── cleanup_manager.py      # クリーンアップ・終了処理(15メソッド)
├── controllers/                # ビジネスロジック制御
│   ├── __init__.py
│   └── index_controller.py     # インデックス・スレッド管理(25メソッド)
├── dialogs/                    # ダイアログ・UI操作
│   ├── __init__.py
│   └── dialog_manager.py       # 各種ダイアログ管理(25メソッド)
└── [既存ファイル群]
```

## 🔧 実装方針

### 1. 段階的移行
- 一度に全てを変更せず、1週間ごとに1つの責務を分離
- 各段階で動作確認を実施
- 問題発生時は即座にロールバック可能

### 2. 既存機能保持
- リファクタリング中も全機能が動作することを保証
- 外部インターフェース(メソッド名・シグナル)は可能な限り維持
- 段階的な内部実装変更

### 3. テスト駆動
- 各段階でテストスイート実行
- 新しいコンポーネントの単体テスト作成
- 統合テストによる全体動作確認

### 4. 依存関係管理
- import文の循環参照を厳密にチェック
- 各コンポーネント間の依存関係を最小化
- インターフェースを通じた疎結合実現

## 📈 成功指標

### 定量的指標
- [ ] main_window.py: 3,605行 → 300行以下(92%削減)
- [ ] メソッド数: 112個 → 10個以下(91%削減)
- [ ] 新機能追加時間: 50%短縮
- [ ] テスト実行時間: 30%短縮

### 定性的指標
- [ ] 新機能追加時の影響範囲が明確
- [ ] 各コンポーネントの単体テストが可能
- [ ] コードレビュー時間の大幅短縮
- [ ] 開発者の理解・保守コストの削減

## ⚠️ リスク管理

### 高リスク要因
1. **シグナル・スロット接続の破綻**
   - 対策: 段階的移行、各段階での動作確認
2. **import循環参照**
   - 対策: 依存関係図の事前作成、インターフェース設計
3. **既存テストの破綻**
   - 対策: テスト実行の自動化、継続的な確認

### 緊急時対応
- 各段階でGitブランチ作成
- 問題発生時の即座ロールバック手順
- 最小限の機能で動作する緊急版の準備

## 🚀 次段階計画

### Phase 2: 他の大規模ファイル対応(Week 6-10)
1. `search_interface.py` (1,504行) の分離
2. `folder_tree.py` (1,409行) の分離
3. GUI層全体の最適化

### Phase 3: アーキテクチャ改善(Week 11-15)
1. MVCパターンの完全実装
2. 依存性注入の導入
3. 非同期処理の最適化

## 📋 チェックリスト

### 開始前確認
- [ ] 現在のコードが正常動作することを確認
- [ ] 全テストが通ることを確認
- [ ] バックアップブランチの作成
- [ ] 開発環境の準備完了

### 各段階完了時確認
- [ ] 移動したメソッドが正常動作
- [ ] 既存テストが全て通る
- [ ] 新しいコンポーネントの単体テスト作成
- [ ] メモリリーク・パフォーマンス確認
- [ ] コードレビュー実施

### 最終完了時確認
- [ ] 全機能の統合テスト完了
- [ ] パフォーマンス目標達成
- [ ] ドキュメント更新完了
- [ ] 次段階計画の策定完了